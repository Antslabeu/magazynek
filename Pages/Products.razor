@page "/products"

@using Magazynek.Entities
@using Magazynek.Services
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage;

@inject IJSRuntime JS
@inject IProductService ProductService
@inject ISystemSettingsService SystemSettingsService

@inject ISessionService SessionService
@inject ProtectedSessionStorage SessionStorage
@inject NavigationManager NavigationManager


<PageTitle>Produkty</PageTitle>

<div class="container mt-4">
    <SearchBar
        OnSearchChanged="SearchChanged"
        SearchBarButtons=@searchBarButtons
        ItemCount="filteredProducts?.Count() ?? 0"
    />
    <table class="table table-dark table-striped table-hover align-middle">
        <thead class="table-dark border-bottom border-light">
            <tr>
                @if(headerNames != null)
                {
                    @foreach(string name in headerNames.A_Value)
                    {
                        <th>@name</th>
                    }
                    <th class="button-th buttons-3">Akcje</th>
                }
            </tr>
        </thead>
        <tbody>
            @if(filteredProducts != null)
            {
                @foreach (Product product in filteredProducts)
                {
                    <tr class="@(product.id == seletedProduct?.id ? "highlighted" : "")">
                        <td>@product.type</td>
                        <td>@product.name</td>
                        <td><BoolPresentation Value="product.active" /></td>
                        <td>@product.description</td>
                        <td>@product.package</td>
                        <td>@product.tmeID</td>
                        <td class="buttons-td">
                            <button class="btn btn-success" @onclick="() => Copy(product)">
                                <i class="fa-solid fa-copy"></i>
                            </button>
                            <button class="btn btn-light" @onclick="() => Edit(product)">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button class="btn btn-danger" @onclick="() => Remove(product)">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>


<div class="modal @(editingProduct!=null?"show":"")">
    <div class="modal-dialog">
        <div class="modal-content text-light bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">
                    @(editingProductIsNew ? "Dodaj produkt" : "Modyfikuj produkt")
                </h5>
                <button type="button" class="btn-close" @onclick="CloseEditModal">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="modal-body">
                @if(headerNames != null && editingProduct != null)
                {
                    Guid g0 = Guid.NewGuid();
                    Guid g1 = Guid.NewGuid();
                    Guid g2 = Guid.NewGuid();
                    Guid g3 = Guid.NewGuid();
                    Guid g4 = Guid.NewGuid();
                    Guid g5 = Guid.NewGuid();


                    <EditForm Model="@editingProduct" OnValidSubmit="SaveProduct">
                        <div class="form-table">
                            <label class="form-label" for="@g0">@headerNames.A_Value[0]</label>
                            <select @bind="editingProduct.type" id="@g0" class="form-control">
                                <option value="">Wybierz...</option>
                                @foreach(string option in productTypes?.A_Value ?? new List<string>())
                                {
                                    <option value="@option">@option</option>
                                }
                            </select>

                            <label class="form-label" for="@g1">@headerNames.A_Value[1]</label>
                            <input 
                                type="text"
                                class="form-control"
                                id="@g1"
                                @bind="editingProduct.name" />
                            
                            <label class="form-label" for="@g2">@headerNames.A_Value[2]</label>
                            <BetterChecker
                                IsChecked="@editingProduct.active"
                                IsCheckedChanged="@((bool val) => editingProduct.active = val)" />

                            <label class="form-label" for="@g3">@headerNames.A_Value[3]</label>
                            <input 
                                type="text"
                                class="form-control" 
                                id="@g3"
                                @bind="editingProduct.description" />

                            <label class="form-label" for="@g4">@headerNames.A_Value[4]</label>
                            <input 
                                type="text"
                                class="form-control" 
                                id="@g4"
                                @bind="editingProduct.package" />

                            <label class="form-label" for="@g5">@headerNames.A_Value[5]</label>
                            <input 
                                type="text"
                                class="form-control" 
                                id="@g5"
                                @bind="editingProduct.tmeID" />
                        </div>

                        <button type="submit" class="btn btn-success space-top lg">
                            <i class="fa-solid fa-floppy-disk"></i>
                        </button>
                    </EditForm>
                }
            </div>
        </div>
    </div>
</div>


@code {
    List<SearchBar.SearchBarButtonItem>? searchBarButtons;

    private string searchTerm = "";
    private ProductViewModel? editingProduct = null;
    private bool editingProductIsNew = false;
    private List<Product> products = new List<Product>();
    private Product? seletedProduct = null;

    private List<SystemSetting> settings = new List<SystemSetting>();
    SystemSetting? productTypes;
    SystemSetting? headerNames;

    User? loggedUser;

    private IEnumerable<Product>? filteredProducts;

    private void SearchChanged(string query) {
        searchTerm = query;
        filteredProducts = products
            .Where(p => string.IsNullOrWhiteSpace(query) ||
                p.type.Contains(query, StringComparison.OrdinalIgnoreCase) ||
                p.name.Contains(query, StringComparison.OrdinalIgnoreCase) ||
                p.package.Contains(query, StringComparison.OrdinalIgnoreCase) ||
                p.farnellID.Contains(query, StringComparison.OrdinalIgnoreCase) ||
                p.tmeID.Contains(query, StringComparison.OrdinalIgnoreCase));
        StateHasChanged();
    }

    protected override void OnInitialized() {
        searchBarButtons = new List<SearchBar.SearchBarButtonItem> {
            new SearchBar.SearchBarButtonItem {
                Class = "btn-success",
                Icon = "fa-solid fa-plus",
                OnClick = EventCallback.Factory.Create(this, AddNew)
            }
        };
    }
    protected override async Task OnAfterRenderAsync(bool firstRender) {
        await base.OnAfterRenderAsync(firstRender);
        if(firstRender)
        {
            loggedUser = await SessionService.GetLoggedUser(SessionStorage);
            if(loggedUser == null) return;

            settings = await SystemSettingsService.GetSettings(loggedUser);

            productTypes = settings.GetSettingByType(SystemSetting.SettingName.Typy_produktów);
            headerNames = settings.GetSettingByType(SystemSetting.SettingName.NameTableProduct);

            productTypes!.A_Value.Sort();

            products = (await ProductService.Get(loggedUser)).OrderBy(p=>p.type).ToList();
            SearchChanged("");
        }
    }
    private void Edit(Product p) {
        editingProductIsNew = false;
        editingProduct = new ProductViewModel(p);
        
        JS.InvokeVoidAsync("document.body.classList.add", "modal-open");
        StateHasChanged();
    }
    private async void Remove(Product p) {
        seletedProduct = p;
        StateHasChanged();
        var ok = await JS.InvokeAsync<bool>(
            "ui.confirm", 
            "Usunąć rekord?", "Tej operacji nie można cofnąć."
        );
        seletedProduct = null;
        StateHasChanged();
        if(!ok) return;

        await ProductService.Remove(p);
        products.Remove(p);
        StateHasChanged();
    }
    private void Copy(Product p)
    {
        editingProductIsNew = true;
        editingProduct = new ProductViewModel(new Product(
            name: p.name + " - KOPIA", 
            package: p.package, 
            farnellID: p.farnellID, 
            tmeID: p.tmeID,
            description: p.description,
            active: p.active,
            type: p.type,
            user: loggedUser!.id
        ));
    }
    
    private void AddNew() {
        if(productTypes == null) return;

        editingProductIsNew = true;
        editingProduct = new ProductViewModel(
            product: new Product(
                name: "NOWY",
                package: "",
                farnellID: "",
                tmeID: "",
                description: "",
                active: false, 
                type: Product.GetSafeDefaultType(productTypes.A_Value),
                user: loggedUser!.id
            )
        );
    }
    private void CloseEditModal() {
        editingProduct = null;
        JS.InvokeVoidAsync("document.body.classList.remove", "modal-open");
        StateHasChanged();
    }
    private async void SaveProduct(object _)
    {
        if(editingProduct == null) return;

        Product newProduct = await ProductService.UpdateInfoOrInsertNew(editingProduct);
        Product? existingProduct = products.FirstOrDefault(x => x.id == newProduct.id);
        if(existingProduct == null) products.Add(newProduct);
        else {
            existingProduct.SetName(newProduct.name);
            existingProduct.SetPackage(newProduct.package);
            existingProduct.SetFarnellID(newProduct.farnellID);
            existingProduct.SetTmeID(newProduct.tmeID);
            existingProduct.SetType(newProduct.type);
        }
        CloseEditModal();

        products = products.OrderBy(p=>p.type).ToList();

        SearchChanged(searchTerm);
    }
}